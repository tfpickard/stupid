name: Sync Sora Videos

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      username:
        description: 'Sora username to sync'
        required: false
        default: 'goatspeed'
      limit:
        description: 'Number of videos to fetch'
        required: false
        default: '20'
      dry_run:
        description: 'Dry run (no files created)'
        type: boolean
        required: false
        default: false

concurrency:
  group: sora-sync
  cancel-in-progress: false

jobs:
  sync:
    name: Sync Sora Videos
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Sora sync script
        env:
          SORA_API_KEY: ${{ secrets.SORA_API_KEY }}
          SORA_USERNAME: ${{ inputs.username || 'goatspeed' }}
          SORA_API_BASE_URL: ${{ secrets.SORA_API_BASE_URL }}
          SORA_RSS_URL: ${{ secrets.SORA_RSS_URL }}
        run: |
          USERNAME="${{ inputs.username || 'goatspeed' }}"
          LIMIT="${{ inputs.limit || '20' }}"
          DRY_RUN="${{ inputs.dry_run && '--dry-run' || '' }}"

          echo "Syncing videos for user: $USERNAME"
          bun run scripts/sync-sora-videos.ts --username="$USERNAME" --limit="$LIMIT" $DRY_RUN

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "New videos detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new videos"
          fi

      - name: Commit new videos
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true
        run: |
          git config user.name "Tom Pickard"
          git config user.email "tom@pickard.dev"

          git add content/media/ public/media/

          # Generate commit message
          NEW_FILES=$(git diff --cached --name-only --diff-filter=A | grep "content/media" | wc -l)

          git commit -m "$(cat <<'EOF'
          feat(sora): auto-sync $NEW_FILES new video(s) from goatspeed

          Automatically synced from Sora API.

          Videos are now available in the feed.
          EOF
          )"

      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true
        run: |
          git push origin ${{ github.head_ref || github.ref_name }}

      - name: Trigger deployment
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'deploy'
            });

      - name: Summary
        if: always()
        run: |
          echo "## Sora Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Username**: ${{ inputs.username || 'goatspeed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Limit**: ${{ inputs.limit || '20' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
